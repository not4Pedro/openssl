name: Interoperability tests with GnuTLS and NSS
on: [pull_request, push]
jobs:
  test:
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - COMPONENT: gnutls
            TYPE: "other,basic,2way"
          - COMPONENT: gnutls
            TYPE: 3way
          - COMPONENT: nss
            TYPE: 2way
    env:
      COMPONENT: ${{ matrix.COMPONENT }}
      TYPE: ${{ matrix.TYPE }}
      SLICEID: ${{ matrix.SLICEID }}
      SLICES: ${{ matrix.SLICES }}
    # Code below inspired by https://fedoramagazine.org/github-actions-use-podman-to-run-fedora-linux/
    steps:
      - name: Setup Podman
        run: |
          sudo apt update
          sudo apt-get -y install podman
          podman pull registry.fedoraproject.org/fedora:latest
      - name: Create container
        run: |
          {
              echo 'FROM fedora:latest'
              echo 'ARG COMPONENT'
              echo 'ARG TYPE'
              echo 'ENV COMPONENT $COMPONENT'
              echo 'ENV TYPE $TYPE'
              echo 'RUN dnf -y update'
              echo 'RUN dnf -y install perl'
              echo 'RUN dnf -y install git tmt-all'
              echo 'RUN dnf -y remove openssl'
              echo 'RUN echo "alias openssl='/openssl/util/wrap.pl /openssl/apps/openssl'" >> ~/.bashrc && source ~/.bashrc'
              echo 'RUN git clone -b interop-tests --recurse-submodules https://github.com/not4pedro/openssl.git'
              echo 'WORKDIR /openssl/'
              echo 'RUN ./config --banner=Configured no-asm no-makedepend enable-buildtest-c++ enable-fips --strict-warnings -D_DEFAULT_SOURCE && perl configdata.pm --dump'
              echo 'RUN make -s -j4'
              echo 'WORKDIR /openssl/interop/'
              echo 'RUN cat <<'EOF' >> setup.sh
                        IFS=',' read -ra ADDR <<< "$TYPE"
                        for i in "${ADDR[@]}"; do
                        echo "$i"
                        done
                        EOF'

          } > podmanfile
          podman build  --build-arg COMPONENT --build-arg TYPE --build-arg SLICES --build-arg SLICEID --tag fedoralatest -f ./podmanfile
      - name : Run tests
      # inspired by GnuTLS configuration: https://gitlab.com/gnutls/gnutls/-/blob/master/.gitlab-ci.yml#L322
        run: |
          podman run -di --name fedoralatest fedoralatest:latest
          echo "Tests to run:"
          podman exec -i fedoralatest tmt run plans -n interop tests -f "tag:interop-openssl" -f "tag:interop-$TYPE" -f "tag:interop-$COMPONENT"  discover -v
          echo "Run the tests:"
          podman exec -i fedoralatest tmt run -a plans -n interop tests -f "tag:interop-openssl" -f "tag:interop-$TYPE" -f "tag:interop-$COMPONENT" provision -h local execute -h tmt --interactive
          # Command to prevent truncation of the output
          echo 'Finished' 
